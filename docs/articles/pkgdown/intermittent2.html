<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intermittent-flow respirometry 2: Complex example • respR</title>
<link rel="shortcut icon" type="image/x-icon" href="../../favicon.ico">
<!-- jquery --><script src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha384-nrOSfDHtoPMzJHjVTdCopGqIqeYETSXhZDFyniQ8ZHcVy08QesyHcnOUpMpqnmWq" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script><!-- Font Awesome icons --><link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.3/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-T8Gy5hrqNKT+hzMclPo118YTQO6cYprQmhrYwIiQ/3axmI1hQomh7Ud2hPOy8SP1" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/1.7.1/clipboard.min.js" integrity="sha384-cV+rhyOuRHc9Ub/91rihWcGmMmCXDeksTtCihMupQHSsi8GIIRDG0ThDc3HGQFJ3" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><meta property="og:title" content="Intermittent-flow respirometry 2: Complex example">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">respR</a>
        <span class="label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0.5</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../../index.html">
    <span class="fa fa-home"></span>
     
  </a>
</li>
<li>
  <a href="../../articles/respR.html">Getting Started</a>
</li>
<li>
  <a href="../../reference/index.html">List of Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Documentation
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/closed.html">Quick-start using closed-chamber respirometry</a>
    </li>
    <li>
      <a href="../../articles/importing.html">Importing your data</a>
    </li>
    <li>
      <a href="../../articles/auto_rate.html">Automatic detection of respirometry rates</a>
    </li>
    <li>
      <a href="../../articles/intermittent.html">Intermittent-flow respirometry: Simple example</a>
    </li>
    <li>
      <a href="../../articles/intermittent2.html">Intermittent-flow respirometry: Complex example</a>
    </li>
    <li>
      <a href="../../articles/flowthrough.html">Flowthrough respirometry</a>
    </li>
    <li>
      <a href="../../articles/pcrit.html">Pcrit analysis</a>
    </li>
    <li>
      <a href="../../articles/intermittent.html">Two-point analysis</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Discussion
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/usage.html">When to use respR</a>
    </li>
    <li>
      <a href="../../articles/performance.html">Performance of auto_rate</a>
    </li>
    <li>
      <a href="../../articles/auto_rate_comp.html">Comparing auto_rate and LoLinR</a>
    </li>
    <li>
      <a href="../../articles/packages_comp.html">A comparison of respR with other R packages</a>
    </li>
    <li>
      <a href="../../articles/tidyverse.html">respR and the tidyverse</a>
    </li>
    <li>
      <a href="../../articles/reproducibility.html">Reproducibility</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/januarharianto/respr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>Intermittent-flow respirometry 2: Complex example</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/januarharianto/respr/blob/master/vignettes/pkgdown/intermittent2.Rmd"><code>vignettes/pkgdown/intermittent2.Rmd</code></a></small>
      <div class="hidden name"><code>intermittent2.Rmd</code></div>

    </div>

    
    
<div id="intermittent-flow-respirometry---a-more-complex-example" class="section level2">
<h2 class="hasAnchor">
<a href="#intermittent-flow-respirometry---a-more-complex-example" class="anchor"></a>Intermittent-flow respirometry - A more complex example</h2>
<p>This vignette shows a more complex intermittent-flow analysis from a long experiment, with many regularly-spaced replicates (except the first one) and a background rate that changes over the course of the experiment. This type of experiment is one many fish physiologists in particular will be familiar with. <code>respR</code> will in the future support these kinds of experiment in a much better way, but for now they are easily analysed with a little data manipulation.</p>
<p>The example data (<code>zeb_intermittent.rd</code>) has kindly been provided by Davide Thambithurai (University of Glasgow), and is from an experiment on a zebrafish. Note, the data has been injected with random noise, and volumes and masses used are not the actual values from the experiment.</p>
</div>
<div id="experiment-overview" class="section level2">
<h2 class="hasAnchor">
<a href="#experiment-overview" class="anchor"></a>Experiment overview</h2>
<p>From this experiment dataset we want to extract several metrics:</p>
<ol style="list-style-type: decimal">
<li><p><em>Pre- and post-experiment background rates</em>. Background rates were recorded at the start and end of the experiment (initial and end sections with shallow slopes). Because this is a long experiment, in high temperatures, the microbial background rate actually increases over the course of the experiment. We will assume this increase is constant (i.e. linear) over the course of the experiment, and each replicate will be corrected with a background rate calculated according to where it occurs along the experiment (i.e. later replicates will be corrected by a greater amount).</p></li>
<li><p><em>Maximum metabolic rate (MMR)</em>. Before this experiment, the fish has been exercised to exhaustion, then placed in the respirometer, so the first replicate during which it is recovering from this exercise will represent MMR. This replicate is 14 minutes duration (13 minutes recording, 1 minute flushing), all the other replicates are 11 minutes in duration (10 minutes recording, 1 minute flushing). See <code><a href="../../reference/zeb_intermittent.rd.html">?zeb_intermittent.rd</a></code> for row locations of all stages.</p></li>
<li><p><em>Routine metabolic rate (RMR)</em>. This will be calculated from the later replicates once the animal has recovered and is using oxygen only to fuel basal metabolism and minor, spontaneous movement.</p></li>
</ol>
<div id="loading-and-inspecting-data" class="section level3">
<h3 class="hasAnchor">
<a href="#loading-and-inspecting-data" class="anchor"></a>Loading and inspecting data</h3>
<p>We use <code><a href="../../reference/inspect.html">inspect()</a></code> to preview the data and save it to an object. This is a <strong>very</strong> large dataset (nearly 80,000 records), so if running the code in this vignette be warned that operations may take some time.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">zeb &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/inspect.html">inspect</a></span>(zeb_intermittent.rd)</code></pre></div>
<p><img src="intermittent2_files/figure-html/unnamed-chunk-2-1.png" width="576"></p>
<p>Because this is a lengthy experiment, the data is too dense to inspect easily from the plots. Here we’ll inspect a portion at the start to illustrate the structure.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw"><a href="../../reference/inspect.html">inspect</a></span>(zeb_intermittent.rd[<span class="dv">1</span><span class="op">:</span><span class="dv">18000</span>, ])</code></pre></div>
<p><img src="intermittent2_files/figure-html/unnamed-chunk-3-1.png" width="576"></p>
<p>The top plot shows the initial background recording, then experimental replicates where O2 decreases, separated by regular flushes where it increases back to ambient levels. The bottom plot (a rate over a rolling window of 20% of the entire data), is not really useful as this window will cover several different replicates, but we can clearly see rates are higher at the start of the data.</p>
</div>
<div id="calculating-background-rate" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-background-rate" class="anchor"></a>Calculating background rate</h3>
<p>The intial and end sections will be used to calculate background rates, and how they change over the course of the experiment. Timepoints of these will typically have been recorded as part of the experiment, so can be used to extract the relevant sections (see <code><a href="../../reference/zeb_intermittent.rd.html">?zeb_intermittent.rd</a></code> for row locations of all stages).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## subset background recordings
backg_start &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/subset_data.html">subset_data</a></span>(zeb, <span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">4999</span>, <span class="dt">by =</span> <span class="st">"time"</span>)
backg_end &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/subset_data.html">subset_data</a></span>(zeb, <span class="dt">from =</span> <span class="dv">75140</span>, <span class="dt">to =</span> <span class="dv">79251</span>, <span class="dt">by =</span> <span class="st">"time"</span>)

## Calc initial and end bg rates
bg_start &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/calc_rate.bg.html">calc_rate.bg</a></span>(backg_start)
bg_end &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/calc_rate.bg.html">calc_rate.bg</a></span>(backg_end)</code></pre></div>
<p><img src="intermittent2_files/figure-html/unnamed-chunk-4-1.png" width="576"></p>
<p>The two different background rates (only the end one shown above) have been saved to these two objects. Support for a dynamic background rate within <code><a href="../../reference/calc_rate.bg.html">calc_rate.bg()</a></code> is in our future development plans, but for now we can use the two rates to derive a linear relationship for the rate to apply based on time along the experiment. We will use these later to correct rates for background.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## extract bg rates and median timepoints
r1 &lt;-<span class="st"> </span>bg_start<span class="op">$</span>bgrate
r2 &lt;-<span class="st"> </span>bg_end<span class="op">$</span>bgrate

t1 &lt;-<span class="st"> </span><span class="kw">median</span>(bg_start<span class="op">$</span>data<span class="op">$</span>Time)
t2 &lt;-<span class="st"> </span><span class="kw">median</span>(bg_end<span class="op">$</span>data<span class="op">$</span>Time)

## fit lm
bg_lm &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">c</span>(r1, r2) <span class="op">~</span><span class="st"> </span><span class="kw">c</span>(t1, t2))

## extract slope and intercept
bg_lm_int &lt;-<span class="st"> </span><span class="kw">coef</span>(bg_lm)[<span class="dv">1</span>]
bg_lm_slp &lt;-<span class="st"> </span><span class="kw">coef</span>(bg_lm)[<span class="dv">2</span>]</code></pre></div>
<p>We will use these later to derive correction values based on time elapsed during the experiment.</p>
</div>
<div id="calculating-mmr" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-mmr" class="anchor"></a>Calculating MMR</h3>
<p>Here we calculate MMR using the first replicate. This replicate is longer than the others (14 mins/840 rows vs. 11 mins/660 rows for all others). For this (and the later analyses) we are going to apply a buffer value at the start of each rep. In this experiment, each replicate is comprises a recording period (13 mins for first rep, 10 mins for all others), followed by 1 minute of flushing. It is good practice to allow a period of settling after flushing, in case the animal was disturbed, or the O2 probe has some lag in detecting the O2 concentration or slight temperature difference. For all analyses we are going to use a 3 minute buffer (180s), that is we won’t use the first 3 mins of data in any rep. We will also only use 7 minutes (420 rows) of data after this so the flush period is not used. Here, we subset the first replicate out to a separate object using these parameters, and use <code><a href="../../reference/auto_rate.html">auto_rate()</a></code> to find the most linear section (we could also use the <code>method = "max"</code> option to find the maximum linear rate <em>within</em> this replicate).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## subset rep 1
zeb_rep_<span class="dv">1</span> &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/subset_data.html">subset_data</a></span>(zeb, <span class="dt">from =</span> <span class="dv">5000</span> <span class="op">+</span><span class="st"> </span><span class="dv">180</span>, <span class="dt">to =</span> <span class="dv">5000</span> <span class="op">+</span><span class="st"> </span><span class="dv">180</span> <span class="op">+</span><span class="st"> </span><span class="dv">420</span>, <span class="dt">by =</span> <span class="st">"time"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## Find most linear section
zeb_mmr &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/auto_rate.html">auto_rate</a></span>(zeb_rep_<span class="dv">1</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; 3 kernel density peaks detected and ranked.</span></code></pre></div>
<p><img src="intermittent2_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>We also need to adjust the rate for background. We will use the background linear model coefficients from above, with the start time of the data we used to calculate the appropriate background rate to apply.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## adjust for background
zeb_mmr_adj &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/adjust_rate.html">adjust_rate</a></span>(zeb_mmr, <span class="dt">by =</span> <span class="dv">5180</span> <span class="op">*</span><span class="st"> </span>bg_lm_slp <span class="op">+</span><span class="st"> </span>bg_lm_int)
<span class="co">#&gt; </span>
<span class="co">#&gt; Rate adjustments applied. Use print() command for more info.</span>
<span class="kw">print</span>(zeb_mmr_adj)
<span class="co">#&gt; </span>
<span class="co">#&gt; # adjust_rate # -------------------------</span>
<span class="co">#&gt; Note: please consider the sign of the value while correcting the rate.</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Rank/position 1 result shown. To see all results use summary().</span>
<span class="co">#&gt; Input rate: -0.00586741</span>
<span class="co">#&gt; Adjustment: -7.586837e-05</span>
<span class="co">#&gt; Adj. rate: -0.005791542</span></code></pre></div>
<p>That’s it: the MMR has been calculated, adjusted and saved, and we can see from the output plots everything looks good. We will convert it to units at the end of the vignette.</p>
</div>
<div id="calculating-rmr" class="section level3">
<h3 class="hasAnchor">
<a href="#calculating-rmr" class="anchor"></a>Calculating RMR</h3>
<p>Calculating RMR is a little more complex. Typically, SMR and RMR are defined as the lowest rates observed. What you choose to use will depend on many factors unique to your experiment, whether that be the absolute lowest rate found, or a representative mean of several low rates. The following is merely to show how you can use <code>respR</code> to explore and extract rates from multiple replicates.</p>
<p>Manually specifying the subsetting criteria for each subequent rep would be onerous, but since we know they cycle at 11 minutes (660s) and there are 105 further replicates after the first ends at row 5839, we can use straightforward R syntax. This is information that will have been recorded as part of the experiment.</p>
<p>There are a number of approaches we could use, but here we will show a simple <code>for</code> loop to run <code><a href="../../reference/auto_rate.html">auto_rate()</a></code> for each replicate from the start of the second replicate (at row 5840), with a starting buffer of 3 minutes (180s), until 7 minutes (420s) later. These data have O2 recorded once per second, so row numbers can be used like this, but it will depend on the time data units used. For this example, we need to specify the original dataframe saved within the <code>zeb</code> object we created using <code><a href="../../reference/inspect.html">inspect()</a></code> (i.e. <code>zeb$dataframe</code>) for the R subsetting syntax to work.</p>
<p>Again, a number of approaches could be used to subset data or iterate the functions to analyse these types of experiment; this is merely a simple example to illustrate how <code>respR</code> can be used over multiple replicates (a more succinct example is at the end of this vignette). Note, for simplicity, we will extract and save only the <em>rate value</em> found. Best practice would be to save the <code><a href="../../reference/auto_rate.html">auto_rate()</a></code> object for each iteration of the loop (i.e. each replicate) in a <code>list</code> object (see eg. at end). We also save the start time of each rep to use later to calculate the correct background rate. Also, while it will greatly increase the time taken, for actual analyses it is <strong>highly</strong> recommended you examine the plot of each iteration, or at very least those that you use. Here in the interests of speed we suppress it with <code>plot = FALSE</code>.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">
## set start rows for each rep
s_r &lt;-<span class="st"> </span><span class="kw">seq</span>(<span class="dv">5840</span>, <span class="dv">74480</span>, <span class="dv">660</span>)
## apply buffer
s_r &lt;-<span class="st"> </span>s_r <span class="op">+</span><span class="st"> </span><span class="dv">180</span>
## set end rows for each rep
e_r &lt;-<span class="st"> </span>s_r <span class="op">+</span><span class="st"> </span><span class="dv">420</span>

## for results
rmr_rates &lt;-<span class="st"> </span><span class="kw">data.frame</span>()

## loop
<span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">105</span>) {
    
    sr &lt;-<span class="st"> </span>s_r[i]  <span class="co"># start row</span>
    er &lt;-<span class="st"> </span>e_r[i]  <span class="co"># end row</span>
    
    ## find most linear rate in each rep
    rmr &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/auto_rate.html">auto_rate</a></span>(zeb<span class="op">$</span>dataframe[sr<span class="op">:</span>er, ], <span class="dt">plot =</span> <span class="ot">FALSE</span>)
    
    ## save time and rate
    rmr_rates[i, <span class="dv">1</span>] &lt;-<span class="st"> </span>sr
    rmr_rates[i, <span class="dv">2</span>] &lt;-<span class="st"> </span>rmr<span class="op">$</span>rate[<span class="dv">1</span>]
}

<span class="kw">names</span>(rmr_rates) &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">"time"</span>, <span class="st">"rmr"</span>)</code></pre></div>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## examine
<span class="kw">head</span>(rmr_rates)
<span class="co">#&gt;   time          rmr</span>
<span class="co">#&gt; 1 6020 -0.008414331</span>
<span class="co">#&gt; 2 6680 -0.003999710</span>
<span class="co">#&gt; 3 7340 -0.006187949</span>
<span class="co">#&gt; 4 8000 -0.004246525</span>
<span class="co">#&gt; 5 8660 -0.003727447</span>
<span class="co">#&gt; 6 9320 -0.002378394</span></code></pre></div>
<p>This <code>rmr_rates</code> dataframe contains the start times and most linear rate found in each rep.</p>
</div>
<div id="correcting-for-background" class="section level3">
<h3 class="hasAnchor">
<a href="#correcting-for-background" class="anchor"></a>Correcting for background</h3>
<p>While there is a function in <code>respR</code> for correcting rates for background (<code>adjust_rate</code>), it doesn’t yet support a dynamic background rate (though see example at the end where a formula can be entered in the function if using <code>apply</code> functions). It will support this in the future, but for now the rates can be easily corrected using the background correction linear relationship we calculated earlier.</p>
<p>Using the time we saved for each rep we will calculate the appropriate correction factor, and add it to the dataframe.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## use time value with lm slope and intercept to get correction factor
rmr_rates<span class="op">$</span>adj &lt;-<span class="st"> </span>rmr_rates<span class="op">$</span>time <span class="op">*</span><span class="st"> </span>bg_lm_slp <span class="op">+</span><span class="st"> </span>bg_lm_int
<span class="kw">head</span>(rmr_rates)
<span class="co">#&gt;   time          rmr           adj</span>
<span class="co">#&gt; 1 6020 -0.008414331 -7.640036e-05</span>
<span class="co">#&gt; 2 6680 -0.003999710 -7.681835e-05</span>
<span class="co">#&gt; 3 7340 -0.006187949 -7.723634e-05</span>
<span class="co">#&gt; 4 8000 -0.004246525 -7.765433e-05</span>
<span class="co">#&gt; 5 8660 -0.003727447 -7.807232e-05</span>
<span class="co">#&gt; 6 9320 -0.002378394 -7.849031e-05</span>
<span class="kw">tail</span>(rmr_rates)
<span class="co">#&gt;      time          rmr           adj</span>
<span class="co">#&gt; 100 71360 -0.002309671 -0.0001177814</span>
<span class="co">#&gt; 101 72020 -0.002204660 -0.0001181994</span>
<span class="co">#&gt; 102 72680 -0.002400156 -0.0001186174</span>
<span class="co">#&gt; 103 73340 -0.002189404 -0.0001190354</span>
<span class="co">#&gt; 104 74000 -0.002263608 -0.0001194534</span>
<span class="co">#&gt; 105 74660 -0.002188329 -0.0001198713</span></code></pre></div>
<p>We can see the ultimate correction value is extremely small in comparison to the rate of the specimen, as it should be. We also see it increasing in value in later reps, as it should.</p>
<p>Note, that in <code>respR</code> we have kept rate values as negatives because mathematically they represent depletion of oxygen (although when you come to report these you should change these to positives). So care must be taken when manually using these values to understand the sign and what is being done. Here, to get a final, adjusted RMR rate we <em>subtract</em> the <code>adj</code> value from the RMR rate we calculated.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">rmr_rates<span class="op">$</span>rmr_adj &lt;-<span class="st"> </span>rmr_rates<span class="op">$</span>rmr <span class="op">-</span><span class="st"> </span>rmr_rates<span class="op">$</span>adj
<span class="kw">head</span>(rmr_rates)
<span class="co">#&gt;   time          rmr           adj      rmr_adj</span>
<span class="co">#&gt; 1 6020 -0.008414331 -7.640036e-05 -0.008337931</span>
<span class="co">#&gt; 2 6680 -0.003999710 -7.681835e-05 -0.003922892</span>
<span class="co">#&gt; 3 7340 -0.006187949 -7.723634e-05 -0.006110713</span>
<span class="co">#&gt; 4 8000 -0.004246525 -7.765433e-05 -0.004168870</span>
<span class="co">#&gt; 5 8660 -0.003727447 -7.807232e-05 -0.003649375</span>
<span class="co">#&gt; 6 9320 -0.002378394 -7.849031e-05 -0.002299904</span></code></pre></div>
<p>If we plot these values (we add the <code>* -1</code> to convert to usual rate-reporting positive values), we can see after the initial period where the fish was recovering from excercise, the rates stablise. Depending on your experiment, you may choose to average a selection of these to define RMR.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">plot</span>((rmr_rates<span class="op">$</span>rmr_adj <span class="op">*</span><span class="st"> </span><span class="op">-</span><span class="dv">1</span>) <span class="op">~</span><span class="st"> </span>rmr_rates<span class="op">$</span>time)</code></pre></div>
<p><img src="intermittent2_files/figure-html/unnamed-chunk-13-1.png" width="576"></p>
</div>
</div>
<div id="conversion-and-next-steps" class="section level2">
<h2 class="hasAnchor">
<a href="#conversion-and-next-steps" class="anchor"></a>Conversion and next steps</h2>
<p>It depends on your experiment how you might want to define your final RMR. The following is just an example where we define it as the mean of the lowest 10th percentile of adjusted rates (again, because rates are negative be careful with the sign - lowest rates are the highest numerically). We can use the <code>quantile</code> function to get the 10% cutoff value, and take the mean of all values lower than this (again careful - it is highest numerically because they are negative).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## 10% quantile cutoff value
co &lt;-<span class="st"> </span><span class="kw">quantile</span>(rmr_rates<span class="op">$</span>rmr_adj, <span class="fl">0.9</span>)

## all rates above cutoff value
rt &lt;-<span class="st"> </span>rmr_rates<span class="op">$</span>rmr_adj[rmr_rates<span class="op">$</span>rmr_adj <span class="op">&gt;</span><span class="st"> </span>co]
rt
<span class="co">#&gt;  [1] -0.001774937 -0.001598904 -0.001761167 -0.001591412 -0.001593165</span>
<span class="co">#&gt;  [6] -0.001735911 -0.001775362 -0.001771523 -0.001768999 -0.001767541</span>
<span class="co">#&gt; [11] -0.001762338</span>

## Calculate RMR
zeb_rmr &lt;-<span class="st"> </span><span class="kw">mean</span>(rt)

## Convert
<span class="kw"><a href="../../reference/convert_rate.html">convert_rate</a></span>(zeb_rmr, <span class="dt">o2.unit =</span> <span class="st">"mg/l"</span>, <span class="dt">time.unit =</span> <span class="st">"s"</span>, <span class="dt">output.unit =</span> <span class="st">"mg/h/g"</span>, 
    <span class="dt">mass =</span> <span class="fl">0.001</span>, <span class="dt">volume =</span> <span class="fl">0.1</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; # convert_rate # ------------------------</span>
<span class="co">#&gt; Rank/position 1 result shown. To see all results use summary().</span>
<span class="co">#&gt; Input:</span>
<span class="co">#&gt; [1] -0.001718296</span>
<span class="co">#&gt; [1] "mg/L" "sec" </span>
<span class="co">#&gt; Converted:</span>
<span class="co">#&gt; [1] -0.6185866</span>
<span class="co">#&gt; [1] "mg/hour/g"</span></code></pre></div>
<p>The MMR value we calculated earlier can also be passed to <code>convert_rate</code> to get the final mass-specific value for this specimen by entering the correct mass (of the fish, in kg) and volume (in L).</p>
<p>Note, the <code>volume</code> is volume of water in the respirometer, <strong>not the volume of the respirometer</strong>. That is, it represents the effective volume; the specimen displaces some of the water, so the volume of water entered here should equal the volume of the respirometer <strong>minus the volume of the specimen</strong>. There are several approaches to calculate the volume of the specimen; geometrically, through displacement in a separate vessel, or calculated from the mass assuming a density value (e.g. for fish it is often assumed they have an equal density as water, that is ~1000 kg/m^3). You could also remove the specimen and directly measure the volume of water remaining.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">## convert
<span class="kw"><a href="../../reference/convert_rate.html">convert_rate</a></span>(zeb_mmr_adj, <span class="dt">o2.unit =</span> <span class="st">"mg/l"</span>, <span class="dt">time.unit =</span> <span class="st">"s"</span>, <span class="dt">output.unit =</span> <span class="st">"mg/h/g"</span>, 
    <span class="dt">mass =</span> <span class="fl">0.001</span>, <span class="dt">volume =</span> <span class="fl">0.1</span>)
<span class="co">#&gt; </span>
<span class="co">#&gt; # convert_rate # ------------------------</span>
<span class="co">#&gt; Rank/position 1 result shown. To see all results use summary().</span>
<span class="co">#&gt; Input:</span>
<span class="co">#&gt; [1] -0.005791542</span>
<span class="co">#&gt; [1] "mg/L" "sec" </span>
<span class="co">#&gt; Converted:</span>
<span class="co">#&gt; [1] -2.084955</span>
<span class="co">#&gt; [1] "mg/hour/g"</span></code></pre></div>
<p>This final value (as a positive) is what we report, or use in further analyses.</p>
</div>
<div id="a-complete-analysis" class="section level2">
<h2 class="hasAnchor">
<a href="#a-complete-analysis" class="anchor"></a>A complete analysis</h2>
<p>The above is a long description with the code expanded to show the analysis in detail, so this vignette may not give a good impression of just how succinct a <code>respR</code> analysis of an experiment like this may be. Here is a code block showing the exact same analysis condensed and using a couple of different R approaches (e.g. using <code>apply</code> functions and <code>list</code> objects to save results). This could be condensed further still depending on how you determine and apply background rates, and if replicates were completely regular or locations already saved to an R object (and condensed even more if you use <code>Tidyverse</code> syntax (LINK)).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co"># Import and inspect raw data ---------------------------------------------</span>

## importing would normally be the first step, e.g. import_file("path/to/file")
z_data &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/inspect.html">inspect</a></span>(zeb_intermittent.rd)

<span class="co"># Background calculations -------------------------------------------------</span>

## calculate start and end background, and fit linear model
bg_s &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/calc_rate.bg.html">calc_rate.bg</a></span>(<span class="kw"><a href="../../reference/subset_data.html">subset_data</a></span>(z_data, <span class="dt">from =</span> <span class="dv">0</span>, <span class="dt">to =</span> <span class="dv">4999</span>, <span class="dt">by =</span> <span class="st">"time"</span>))
bg_e &lt;-<span class="st"> </span><span class="kw"><a href="../../reference/calc_rate.bg.html">calc_rate.bg</a></span>(<span class="kw"><a href="../../reference/subset_data.html">subset_data</a></span>(z_data, <span class="dt">from =</span> <span class="dv">75140</span>, <span class="dt">to =</span> <span class="dv">79251</span>, <span class="dt">by =</span> <span class="st">"time"</span>))

## fit lm
bg_mod &lt;-<span class="st"> </span><span class="kw">lm</span>(<span class="kw">c</span>(bg_s<span class="op">$</span>bgrate, bg_e<span class="op">$</span>bgrate) <span class="op">~</span><span class="st"> </span><span class="kw">c</span>(<span class="kw">median</span>(bg_s<span class="op">$</span>data<span class="op">$</span>Time), <span class="kw">median</span>(bg_e<span class="op">$</span>data<span class="op">$</span>Time)))

## extract slope and intercept
bg_mod_int &lt;-<span class="st"> </span><span class="kw">coef</span>(bg_mod)[<span class="dv">1</span>]
bg_mod_slp &lt;-<span class="st"> </span><span class="kw">coef</span>(bg_mod)[<span class="dv">2</span>]

<span class="co"># Calculate rates in each replicate ---------------------------------------</span>
## Set start rows of each replicate (remember, first one is 14 mins, all others 11mins)
sr &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="dv">5000</span>, <span class="kw">seq</span>(<span class="dv">5840</span>, <span class="dv">74300</span>, <span class="dv">660</span>))

## apply auto_rate to each rep, from start row (+ 3 mins buffer) to 10 mins (600s) later
z_ar &lt;-<span class="st"> </span><span class="kw">lapply</span>(sr, 
               <span class="cf">function</span>(g) <span class="kw"><a href="../../reference/auto_rate.html">auto_rate</a></span>(zeb<span class="op">$</span>dataframe[(g<span class="op">+</span><span class="dv">180</span>)<span class="op">:</span>(g<span class="op">+</span><span class="dv">600</span>),], <span class="dt">plot =</span> F))

<span class="co"># Adjust rates for background ---------------------------------------------</span>
## background adjust each rep based on start time of that rep
z_ar_adj &lt;-<span class="st"> </span><span class="kw">lapply</span>(z_ar, 
                   <span class="cf">function</span>(g) <span class="kw"><a href="../../reference/adjust_rate.html">adjust_rate</a></span>(g, g<span class="op">$</span>df<span class="op">$</span>x[<span class="dv">1</span>] <span class="op">*</span><span class="st"> </span>bg_mod_slp <span class="op">+</span><span class="st"> </span>bg_mod_int))

<span class="co"># Convert rates -----------------------------------------------------------</span>
z_rates_final &lt;-<span class="st"> </span><span class="kw">lapply</span>(z_ar_adj, <span class="cf">function</span>(g) <span class="kw"><a href="../../reference/convert_rate.html">convert_rate</a></span>(g, 
                                                           <span class="dt">o2.unit =</span> <span class="st">"mg/l"</span>,
                                                           <span class="dt">time.unit =</span> <span class="st">"s"</span>,
                                                           <span class="dt">output.unit =</span> <span class="st">"mg/h/g"</span>,
                                                           <span class="dt">mass =</span> <span class="fl">0.001</span>,
                                                           <span class="dt">volume =</span> <span class="fl">0.1</span>))

<span class="co"># Extract and define MMR and RMR ------------------------------------------</span>

## MMR = rate from replicate 1
z_mmr &lt;-<span class="st"> </span>z_rates_final[[<span class="dv">1</span>]]<span class="op">$</span>output[<span class="dv">1</span>]

## RMR = mean of lowest 10th percentile of all rates (n.b. numerically highest
## 10th percentile, because of negative sign)
z_all_rates &lt;-<span class="st"> </span><span class="kw">sapply</span>(z_rates_final, <span class="cf">function</span>(g) g<span class="op">$</span>output[<span class="dv">1</span>])
z_rmr &lt;-<span class="st"> </span><span class="kw">mean</span>(z_all_rates[z_all_rates <span class="op">&gt;</span><span class="st"> </span><span class="kw">quantile</span>(z_all_rates, <span class="fl">0.9</span>)])</code></pre></div>
<p>We can see we get same values we calculated above.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">z_mmr
<span class="co">#&gt; [1] -2.084955</span>
z_rmr
<span class="co">#&gt; [1] -0.6185866</span></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#intermittent-flow-respirometry---a-more-complex-example">Intermittent-flow respirometry - A more complex example</a></li>
      <li><a href="#experiment-overview">Experiment overview</a></li>
      <li><a href="#conversion-and-next-steps">Conversion and next steps</a></li>
      <li><a href="#a-complete-analysis">A complete analysis</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by Januar Harianto, Nicholas Carey.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="http://pkgdown.r-lib.org/">pkgdown</a>.</p>
</div>

      </footer>
</div>

  

  </body>
</html>
