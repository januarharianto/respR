---
title: "Flowthrough respirometry"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{respR - Measuring intermittent-flow data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.width=7, fig.height=7)
```

### Introduction

Flowthrough respirometry differs from other methods in that oxygen depletion is measured from a known continuous flow of water through a respirometer, rather than a known volume, typically after the system has achieved equilibrium. In this method, two oxygen concentrations are needed; 'upstream' and 'downstream' of the experimental chamber, or inflow and exflow concentrations. The inflow concentration is typically a known fixed value and often not continuously monitored, such as fully air-saturated water, or water from a header tank of controlled oxygen concentration. The difference between inflow and outflow concentrations, the O₂ delta, and the flow rate allow calculation of the uptake by the specimen.

### Example data

The example data, `flowthrough`, contains measurements of oxygen consumption in a species of chiton, (*Mopalia lignosa*, Carey, *unpublished*).  Detailed information about the data, including its source and methods, can be obtained with the command `?flowthrough`. 

```{r}
library(respR)
data("flowthrough.rd")
head(flowthrough.rd)
```

We can see this dataset contains time values, both outflow and inflow O₂ concentrations, and an O₂ delta, which is simply the inflow substracted from the outflow. The inflow (`o2.up`, which maintains a clearly consistent mean value of 8.88) and O₂ delta columns are not required; we include them here to show different analyses later. Strictly speaking, the Time column is also not required for the analysis, but most continuous data should have an indication of when data were recorded. 

### Inspecting data
Continuous flowthrough data can be inspected for common errors using the `inspect_data` function, but because these data will be slightly different we need to keep some things in mind. By default, `inspect_data` assumes Time data in column 1 and O₂ data in column 2. For flowthrough data we typically want to look at the outflow O₂ data:

```{r}
inspect_data(flowthrough.rd)
```

Unlike in typical closed respirometry datasets, as long as equilibrium has been acheived in the flowthrough experiemnt, oxygen should not decline over time, and so regions where rates are consistent are more easily identified. Here, using the top plot, we can see the outflow O₂ concentration is most consistent in the early stages of the experiment. Since we know in this experiment inflow O₂ is more-or-less unvarying, this means the specimen's rate is also most conistent here. In closed respirometry data, the bottom plot shows how the rate of the specimen varies over the dataset, but here it shows the rate of change in outflow O₂ concentration. Therefore, values close to zero indicate regions of highly consistent rates by the _specimen_. Here, we can see this illustrated well between rows 200 and 400.

If, for experimental reasons, the inflow O₂ concentration is variable, examining consistency in outflow O₂ would not equate to consistent rates by the specimen. Instead, we can examine O₂ delta data. 

```{r message=FALSE, warning=FALSE, results = "hide"}
inspect_data(flowthrough.rd, xcol = 1, ycol = 4)
```

Here, we can see that after taking into account variable inflow O₂, the uptake rates of the specimen are most consistent between rows 200 and 300. 

The output can be saved as an object and passed to the next function for determining rates. However, note that the default behaviour of `inspect_data` is preserved, with a 2-column data frame created from the inspected data, in which case other columns such as inflow O₂ and O₂ delta would not be included. 
```{r message=FALSE, warning=FALSE, fig.keep="none", results="hide"}
chiton_ft <- inspect_data(flowthrough.rd, xcol = 1, ycol = 2)
```
```{r message=FALSE, warning=FALSE, fig.keep="none"}
head(chiton_ft$df)
```

We can change this by changing the column selectors. O₂ delta data can also be analysed to determine rates, as described below. 
```{r message=FALSE, warning=FALSE, fig.keep="none", results="hide"}
chiton_ft_delta <- inspect_data(flowthrough.rd, xcol = 1, ycol = 4)
```
```{r message=FALSE, warning=FALSE, fig.keep="none"}
head(chiton_ft_delta$df)
```

### Flowthrough rate function
Flowthrough data can be analysed using the `calc_rate.ft` function. This function accepts several forms of data input; 

1. Single values of inflow and outflow concentrations

    ```calc_rate.ft(inflow.o2 = 8.88, outflow.o2 = 8,17, flowrate = 0.000039)```

2. A single value for inflow concentration, a vector of multiple values for outflow concentrations

    ```calc_rate.ft(inflow.o2 = 8.88, outflow.o2 = c(8,17, 8.16, 8.15), flowrate = 0.000039)```  
    ```calc_rate.ft(inflow.o2 = 8.88, outflow.o2 = flowthrough.rd$o2.down, flowrate = 0.000039)```

3. Vectors of equal length with paired values for inflow and outflow concentrations

    ```calc_rate.ft(inflow.o2 = c(8.88, 8.87, 8.89), outflow.o2 = c(8,17, 8.16, 8.15), flowrate = 0.000039)```   
    ```calc_rate.ft(inflow.o2 = flowthrough.rd$o2.up, outflow.o2 = flowthrough.rd$o2.down, flowrate = 0.000039)```

4. A dataframe containing columns of paired outflow and inflow O₂ values. Columns can be identified using `out.col` and `in.col`  

    ```calc_rate.ft(data = flowthrough.rd, out.col = 2, in.col = 3)```

5. An object of class `inspect_data`. If this is outflow O₂ data, a single value for inflow O₂ is required. Data with variable inflow O₂ should be analysed using an O₂ delta (see below).

    ```calc_rate.ft(chiton_ft, inflow.o2 = 8.88, flowrate = 0.00039)```  
    
In all the above cases the function calculates the difference between inflow and outflow O₂ values, the O₂ delta. However this can be entered directly as `delta.o2`;

```
# Single values
calc_rate.ft(delta.o2 = 0.71, flowrate = 0.000039) 
# Delta O₂ vector
calc_rate.ft(delta.o2 = c(0.71, 0.71, 0.74), flowrate = 0.000039)
calc_rate.ft(delta.o2 = flowthrough.rd$o2.delta, flowrate = 0.000039)
# Class `inspect_data` and inflow.o2 = NULL
calc_rate.ft(chiton_ft_delta, flowrate = 0.00039)
```


It is assumed `flowrate` will be an unvarying parameter within each separate experiment. Recordings at different flow rates should be analysed separately. Units for flow rate will be specified when rates are converted later (see below). 

### Subsetting data and calculating rates

The `calc_rate.ft` function supports subsetting by row and time values, and only works with data frames or objects of class `inspect_data`. We saw earlier how rates between rows 200 and 300 appeared to be most consistent. We will calculate rates from this data region based on both outflow O₂ values and O₂ delta values. 

```{r}
chiton.ft.rate <- calc_rate.ft(flowthrough.rd,  inflow.col = 2, outflow.col = 3, flowrate = 0.000039, from = 200, to = 300, by = "row")
print(chiton.ft.rate)
```
```{r}
chiton.ft.rate.delta <- calc_rate.ft(delta.o2 = chiton_ft_delta$df$o2.delta, flowrate = 0.000039, from = 200, to = 300, by = "row")
print(chiton.ft.rate.delta)
## *** NOT WORKING - currently can't subset delta data ***
```

As would be expected, the two methods give identical results. The output object includes all calculated rates within the subset and a mean rate.

### Adjusting rates

Similar to the other respirometry methods, a background rate value (typically negative) can be used to adjust flowthrough rates. 
``` {r}
adjust_rate(chiton.ft.rate$mean, by = -0.000001)
```

### Converting rates

The `convert_rate` function is used to convert rates to particular units. Converting flowthrough rates requires the `o2.unit` of the data, and a flow rate unit, `flow.unit`. However, there are inputs for `volume` or `time.unit` are not required since these are incorporated into the flow rate unit (e.g. L/s). The `flow.unit` must be in SI units of litres per unit time; L/s, L/m, or L/h. The function returns a rate for the whole specimen, and if a `mass` is entered it returns a mass-specific rate. 

```{r}
# obviously not yet working
#convert_rate(chiton.ft.rate$mean, o2.unit = 'mg/l', flow.unit = "l/s", output.unit = "mg/h")
#convert_rate(chiton.ft.rate$mean, o2.unit = 'mg/l', flow.unit = "l/s", mass = output.unit = "mg/h/g")
```

