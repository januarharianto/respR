---
title: "respiRe - An R package for processing oxygen flux data"
author: "Januar Harianto & Nicholas Carey"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{respiRe - An R package for processing oxygen flux data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>")
```

## Summary
Here we introduce `respiRe`, an R package that provides a comprehensive workflow for the processing and analysis of oxygen flux measurement data in respirometry experiments. 

## Introduction
...

## Methods
To explore `respiRe` and its main functions we first load the example data, `urchin2013`, which consists of measurements of oxygen consumption rates in 16 individual urchins and 6 "blank" measurements of background respiration (Harianto, *unpublished*). Detailed information about the data, including its source and methods, can be found by invoking `?urchin2013`.

```{r}
library(respr)
data(urchin2013)
urchin2013
```

`respiRe` provides the following functions to manipulate and analyse dissolved data:

1. `check.input` checks for structural errors and select individual data from multi-column datasets.
2. `calc.bg.rate` calculates background changes in DO
3. `calc.rate` calculates the rate of oxygen flux (i.e. rate of change of dissolved O2 over time) over any specified subset of the data frame.
4. `calc.MO2` converts the output of `calc.rate` for volume and/or weight-specific rates or oxygen flux (e.g. weight-specific metabolic rate).

When performed in order, the above functions represent a typical workflow in the analysis of respirometry or similar data, where a user first checks for errors before perfoming analytic functions to obtain a properly-scaled rate of change in dissolved oxygen (DO) over time.

In addition, a few useful functions exist for specific data preparation and analysis scenarios:

1. `convert.units` to convert DO units (e.g.from % to mg/L).
2. `subsample.data` to thin a large dataset.
3. `smooth.data` to perform a rolling average on a noisy dataset to produce "smoother" data for analysis.
4. `auto.rate` to perform rolling regressions of a fixed width across all rows of an entire data frame and automatically obtain maximum, or minimum rates.
5. `pcrit` to calculate the breakpoint in metabolic rate, based on Yeager and Ultsch (1989).


### `check.input`

`check.input` scans incoming data frames specific to timeseries and DO data for structural errors that may impede further analysis in R. Typically, a user may read data into R from a single spreadsheet file consisting of multiple columns of data. Invoking the function on a data frame perfoms a check on every column testing for data structure and common errors, which include: 

- data length, and tests for equal-length columns if a 2-column data frame is read;
- *NA* checks, which imply missing data;
- *NaN* checks (i.e. non-numeric data), which may indicate "typos" in data entry, improper time formats, or wrongful classification of data in R; 
- duplicate numbers, which shouldn't happen in time columns; and 
- evenly-spaced data, which influences subsetting choices in `calc.rate` if time data are not spaced equally. 

A user may not necessarily use `check.input` before running `calc.rate`, although it minimises errors and is useful as an exploratory tool before proceeding with the main analysis.

```{r, eval=F}
check.input(urchin2013)
```

`check.input` may also be used to subset two individual columns and produce a new data frame, e.g. `check.input(urchin2013, x = 1, y = 15)`. The user could use the function *directly* on a two-column dataset, and not specify the x and y arguments. As long as the first column is a timeseries, and the second column is DO data, the function will be able to successfully check the data for errors or warnings specific to their data types. If data successfully passes the checks, `check.input` produces a data frame object that can be saved and used in subsequenct functions, and also display a scatter plot of the data for visual inspection.


```{r, fig.width=4, fig.height=3}
# create subset for urchin #15 where column 1 is the time column and column 15 is the data for the urchin
urchin.n <- check.input(urchin2013, 1, 15)
```

The output plot reveales non-linear irregularities in the data. In this particular case, the sea urchin had climbed on top of the oxygen sensor, blocking it from proper water mixing for about 10 minutes. A linear regression of the entire data will result in an underestimate of the true rate. The user has several options to manage non-linear portions of a dataset once the data is passed on to the main functions, `calc.rate` and `auto.rate`.

### `calc.bg.rate`

For some experiments, a user may need to account for background changes in DO due to microbial respiration and/or photosynthesis, or during open respirometry experiments where there may be oxygen input from surrounding air. A correction may also be applied in open respirometry, where  Using `calc.bg.rate`, a user can process single, or multiple background respiration data simultaneously. The returned object can be saved and used within `calc.rate` and `auto.rate` for automatic corrections to the output. In `urchin2013`, there are 4 measurements of background 

```{r}
# Produce a data frame of background respiration data
urchin.bg <- calc.bg.rate(urchin2013, timecol = 1, bgcol = c(18:21))
```

### `calc.rate`

`calc.rate` performs a least-squares linear regression on a dissoloved oxygen timeseries. Depending on the user's methods, the timeseries data may first be truncated either by time ("What is the average rate of change in DO within 30 minutes?"), oxygen concentration ("How long does it take for oxygen concentration to drop from 7 to 6 units?"), proportion based on the total change in oxygen ("How long does it take for DO to reach 0.5 of the total decrese?"), or row number in the column ("What is the rate at this precise section of the data?"). While the default truncating method is by time, this can be changed by modifying the argument `by` in the function, e.g. `by = 'row'`.

```{r, fig.width=4, fig.height=3}
# What is the average rate of change in DO in the first 30 min?
calc.rate(urchin.n, from = 0, to = 30)
```

```{r}
# How long does it take for oxygen concentration to drop from 7.5 to 7.25?
calc.rate(urchin.n, 7.5, 7.25, by = 'o2')
```

```{r}
# How long does it take for DO to reach 50% of the total decrease?
calc.rate(urchin.n, 1, 0.5, by = 'proportion')
```

```{r}
# What is the rate at this specific window?
calc.rate(urchin.n, 25, 130, by = 'row')

```

### `auto.rate`

```{r, fig.width=4, fig.height=3}
auto.rate(urchin.n)
```
