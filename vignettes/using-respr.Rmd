---
title: "respiRe - An R package for processing respirometry data"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{respiRe - An R package for processing oxygen flux data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo=F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.width=7, fig.height=7)
```

## 1. Introduction

Here we introduce `respiRe`, an R package that provides a colletion of functions to simplify the processing and analysis of respirometry and related experiments.





## 2. Methods

Rates of oxygen consumption/production, such as respiration rate, are commonly analysed in either of two ways: (1) using a two-point difference of values, over a fixed period of time (e.g. citations); or (2) using ordinary least-squares (OLS) linear regression of data between two points (e.g. citations). The default method for `calc.rate` is OLS linear regression, and there are no plans to implement the two-point method in the future. However, the output of `calc.rate` provides sufficient information on associated row numbers, time and O~2~ data for a user to manually perform a two-point calculation where necessary.


### 2.1 Example data

To explore `respiRe` and its main functions we load the first example data, `urchin2013`. The dataset contains measurements of oxygen consumption in 16 individual sea urchins (*Heliocidaris erythrogramma*) and 2 "blank" measurements of background respiration (Harianto, *unpublished*). Detailed information about the data, including its source and methods, can be obtained with the command `?urchin2013`.


```{r}
library(respr)
data(urchin2013)
urchin2013
```

`respiRe` provides the following functions to manipulate and analyse dissolved oxygen data:

1. `check.input` checks for structural errors and select individual data from multi-column datasets.
2. `calc.bg.rate` calculates background changes in dissolverd oxygen (DO).
3. `calc.rate` calculates the rate of change of DO over time in a data frame, or its subset.
4. `calc.MO2` converts a number, or an object of class of `calc.rate`, to volume and/or weight-specific rates or oxygen consumption/production (e.g. weight-specific metabolic rate).

In addition, a few useful functions exist for specific data preparation and analysis scenarios:

5. `convert.units` converts DO units (e.g.from % to mg/L).
6. `subsample.data` thins a large dataset by sampling every *n* rows.
7. `smooth.data` performs a rolling average over a dataset to produce "smoother" data for analysis.
8. `auto.rate` automatically determines maximum, minimum, or continuous linear rate of change of DO over time.
9. `pcrit` calculates the breakpoint in metabolic rate, based on the "hockey stick" method in Yeager and Ultsch (1989).


### 2.2. `check.input`

We first use `check.input` to scan the dataset for missing data, non-numeric data equal data lengths. Duplicate and unevenly-spaced data, specific to time, are also examined. Checks are performed on all columns in the data, regardless of data type:

```{r, eval=FALSE}
check.input(urchin2013)
```


If we call `check.input` over a two-column dataset, the function will automatically identify the first column as time data, and the second column as DO data. Error checks will be specific to the data types, and error messages are more informative (e.g. duplicates in time data will be called out). We can also subset a large data frame directly by specifying the *x* and *y* arguments that correspond to columns in the data frame. 

With two-column data frames, `check.input` will automatically remove NA data and produce a new data frame that we can use for subsequent analyses, while larger datasets are not modified in any way. A scatterplot of the data is also produced automatically for quick visual inspection.

```{r, fig.width=7, fig.height=7}
u2 <- check.input(urchin2013, x = 1, y = 15)
```

From the plot, non-linear irregularities in the data are evident. In this case, there is a change in the rate of oxygen uptake near the end of the timeseries (the sea urchin had climbed on top of the oxygen sensor, blocking it from surrounding water). A linear regression of the data frame would result in an underestimate of the true rate. We have several options to manage irregular, or non-linear portions of the data. For now, the data frame is saved as an object for later analysis.

It should be noted that invoking `check.input` is optional - the main functions in our package will readily accept any data frame as long as data are all numeric and error-free. Running `check.input` is a qualitative step that simply flags potential issues about the data.


### 2.3 `calc.bg.rate`

The presence of microorganisms in the respirometry medium may be a potential source of significant experimental bias, and some users may want to account for background rates while running the main experiment. Since background rates typically account for a small percentage of experimental rates, these often-called "blank" experiments are routinely conducted alongside, or before and after main experiments, and the rates are averaged across all datasets to obtain a single correction. 

The function `calc.bg.rate` can be used to simultaneously process single or multiple background rate measurements, provided that the time data is identical between measurements. An OLS linear regression is performed on the entire dataset to obtain background rates and scatterplots of all data may be previewed simultaneously by invoking the argument `plot = TRUE`.

In `urchin2013`, background respiration was recorded and saved in columns 18 and 19. We analyse the data with `calc.bg.rate` and save the output as an object.

```{r}
ubg <- calc.bg.rate(urchin2013, timecol = 1, bgcol = c(18:19), plot = T)
print(ubg)
```


### 2.4 `calc.rate`


The function `calc.rate` performs an OLS linear regression on a data series. Calling the function without any additional arguments will result in a linear regression analysis of the entire data frame.

```{r, eval=F}
calc.rate(u2)
```

In many cases, there is a need to truncate the data before rate could be determined, and the reasons for doing so may depend on the goal of the study being conducted. For example, a user may want to determine rate over an exact period of time, or only estimate the rate that is beyond a threshold of O~2~ concentration. Interference to sensitive equipment may also cause temporary irregularities or "spikes" in the data, as shown in our example above. However, as long as the rate was consistent before and after a "spike", there is no reason to discard the data. Instead, we can work around the error and subset the regions that are not erroneous, and confidently obtain valid rates (e.g citations). 

The `calc.rate` function allows us to subset the data based on the `from` and `to` arguments, in one of 4 ways, to answer different kinds of research questions:

1. Time period (`by = "time"`) - "What is the average rate over a 25 minute period?"
2. Total oxygen consumed/produced (`by = o2`) - "At what rate is oxygen consumed between saturation points of 95% and 80%?"
3. Proportion based on total oxygen consumed (`by = proportion`) - "What is the rate from halfway down to thre-quarters of the data?"
4. Precise subsetting by row for any other reason (`by = row`).


Here we subset the data by time and include background respiration that had been saved by `calc.bg.rate` as before. Plotting the output provides a series of diagnostic plots of the data subset that was analysed.

```{r}
u.rate <- calc.rate(u2, from = 4, to = 29, by = "time", background = ubg)
print(u.rate)
plot(u.rate)
```




Now convert to volume-and-weight specific MO~2~.
```{r}
calc.mo2(u.rate, unit.in = "mg/l/s", unit.out = "mg/s/kg", volume = 1.89, mass = 0.13)
```


