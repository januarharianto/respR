---
title: "Determining $P_{crit}$"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteIndexEntry{Determining $P_{crit}$}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, echo = F}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", fig.width=7, fig.height=7)
```

### Introduction

$P_{crit}$ is the concentration above which oxygen uptake is independent of the concentration. In some species - oxyconformers - routine oxygen uptake is proportional to oxygen concentration, and so at 50% $O_2$, the uptake rate will be half that at 100% $O_2$. Many species however - oxyregulators - are able to regulate uptake, and maintain routine rates as oxygen decreases (although, in reality there is a continuum of responses and intermediate cases). The concentration below which routine uptake becomes unsustainable is termed the critical partial pressure of $O_2$, or simply $P_{crit}$. It is typically determined in long term, closed respirometry experiments in which the specimen is allowed to deplete the oxygen in the chamber to hypoxia, and identifying the breakpoint in the relationship of uptake rate to $O_2$. 

### Example data

The example data, `squid.rd`, contains measurements of oxygen consumption in the market squid, *Doryteuthis opalescens*. Detailed information about the data, including its source and methods, can be obtained with the command `?squid.rd`. 

```{r}
library(respR)
data("squid.rd")
head(squid.rd)
```

This dataset is extremely large; over 34000 rows representing 9.5h of data. The functions in `respR` are highly optimised and efficient, but users on older machines may want to use the `subsample` function to thin the dataset before running the following code. 

### Inspecting data
We can inspect the dataset using the `inspect_data` function. 

```{r}
market.squid <- inspect_data(squid.rd)
```

We can see from the bottom plot the uptake rate is relatively consistent to around the 10,000th row (this will differ in thinned data), after which it declines steadily, but we do not know from this plot what $O_2$ concentration this represents. For now, we can see the dataset is sound so we can pass the saved `market.squid` object to the next function. 

### $P_{crit}$ function
The `pcrit` function uses two methods to estimate the breakpoint in the rate~$O_2$ relationship. The first is a “broken-stick” regression (BSR) approach, adapted from Yeager & Ultsch (1989) in which two segments of the data are iteratively fitted and the intersection with the smallest sum of the residual sum of squares between the two linear models is the estimated critical point. The second  is a wrapper for the segmented, or “broken-line” regression approach, available as part of the `segmented` R package (Muggeo 2008), which estimates the critical point by iteratively fitting two intersecting models and selecting the point that minimises the “gap” between the fitted lines (see `?pcrit` for full references). 

We will pass the data frame contained in `market.squid` to `pcrit` with the default operators:

```{r}
market.squid.pcrit <- pcrit(market.squid$df)
print(market.squid.pcrit)
```

The output figure shows both methods and their metrics plotted against the original data and on a rate~$O_2$ plot. The `print` summary shows that, in this case, both methods give very similar values for the $P_{crit}$: 2.61 and 2.62 mg/L. We should note that for some data, depending on various characteristics, such as noisyness, abruptness of the break, etc. the two methods may provide results that differ. The plots will allow the user to judge which method works better at identifying the 'true' $P_{crit}$ value. We should also note the `width` operator, which controls the width of the rolling regressions used to calculate the rolling rate values, will also affect estimations of the $P_{crit}$. The default value of 0.1 of the total length of data in our testing seems to provide good results, but in some data changing this may give better results. 

This example used raw Time~$O_2$ data, and so the function calculated a rolling rate internally. However, the user can input already calculated rate~$O_2$ data using the argument has.rate = TRUE, and the function will determine Pcrit using these data directly. These data can be either whole specimen rates ("$VO_2$"), or mass-specific rates ("$MO_2$"); both give identical results. 

### Adjustments
The `pcrit` function does not support adjusting rates for background effects. Background $O_2$ uptake should not affect $P_{crit}$ as it is typically assumed to be uniform over the course of an experiment. Users should be aware that rates extracted from objects of class `pcrit` will not have been background-corrected.

### Extracting results
Results of `pcrit` analyses can be extracted from the results object via the following:

```{r}
# Broken-stick regression (Yeager & Ultsch, 1989)
market.squid.pcrit$result.intercept
# Segmented regression (Muggeo 2003).
market.squid.pcrit$result.segmented
```