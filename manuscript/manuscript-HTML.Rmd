---
title: "`respR` - An R package for the analysis of respirometry data"
author: "Januar Harianto, Nicholas Carey, Maria Byrne"
output: 
  html_document:
    toc: false
    number_sections: true
    fig_caption: true
    pandoc_args: ["-F","pandoc-crossref"]
    theme: "united"
---

```{r, echo = F}
library(respR)
library(knitr)
library(readr)

# set pander table-layout options
library(pander)
panderOptions('table.alignment.default', function(df)
    ifelse(sapply(df, is.numeric), 'right', 'left'))
panderOptions('table.split.table', Inf)
panderOptions('big.mark', ",")
panderOptions('keep.trailing.zeros', TRUE)

opts_chunk$set(collapse = TRUE, comment = "#>", tidy = TRUE, highlight = TRUE)
```

# Introduction

Metabolic rate is a fundamental trait linked to virtually all other biological functions, and is key to the prediction of patterns in ecology and conservation biology, from populations (Seibel and Drazen, 2007, Barneche et al., 2014) to ecosystems (Brown et al., 2004). It has been widely used to investigate the effects of external stressors on an organism, and has seen increased popularity in studies involving climate change where warming is expected to drive increased metabolism in ectotherms (Pörtner, 2002, McElroy et al., 2012, Carey et al., 2016, Delorme & Sewell, 2016). By far the most common metric used to measure physiological performance in animals, it has been applied from the whole organism to the level of cells and tissues (White & Kearney, 2013), and is typically quantified using respirometry, which measures oxygen uptake over time (Lighton, 2008).

There are at least four broad methodological approaches in respirometry: closed, intermittent flow, flowthrough and open. In closed respirometry, $O_2$ decrease is measured within a hermetically sealed chamber of known volume, sometimes set within a closed loop to allow circulation or mixing of the environment within the chamber. The oxygen recordings may be continuous through use of an oxygen probe, periodic through withdrawing water or gas samples at set intervals, or a two-point measurement consisting of the initial and final concentrations. Metabolic rates are estimated from respirometry by assuming a linear relationship between variables, and estimates of metabolic rate are straightforward in constant volume respirometry using the equation: $$VO_2 = \Delta O_2(V)$$ where $\Delta O_2$ is the slope of the regression that relates O~2~ concentration to time, or in the case of a two-point measurement, the difference in $O_2$ concentration divided by time, and $V$ is the volume of the container (Lighton, 2008). 

In intermittent flow respirometry, $O_2$ concentration is measured, but after a set time period the chamber is flushed with new water or air, returning it to initial conditions, sealed again, and the experiment repeated (Svendsen et al., 2016). This technique is essentially closed respirometry, but with the incorporation of repeated measures. Depending on the metabolic rate metric being investigated, final respiration rate is calculated as the mean of the measures (e.g. citation), or the lowest or highest rates recorded in any trial (e.g. Carey et al., 2016).

Flowthrough respirometry involves a closed chamber, but with a regulated flow of air or water through it at a precisely determined rate. After equilibrium has been achieved, the oxygen concentration differential between the incurrent and excurrent channels, along with the flow rate, allows calculation of the oxygen extracted from the flow volume per unit time: $$VO_2 = (C_iO_2 - C_eO_2)FR$$ where $VO_2$ is the rate of $O_2$ consumption in milligrams per minute, $C_iO_2$ and $C_eO_2$ are the incurrent and excurrent $O_2$ concentrations, and $FR$ is the flow rate of water through the system  (Lighton, 2008).

A final method is open respirometry, in which an open tank or semi-enclosed area is used, but the input or mixing rate of oxygen from the surroundings is known or found to be negligible relative to oxygen consumption of the specimens (Leclercq et al., 1999). It is seldom used, but for some applications it is a sufficient and practical methodology (e.g. Gamble et al., 2014). The common equation used for open respirometry is: $$VO_2 = \Delta O_2 + \phi_d$$ where $\Delta O_2$ is the slope of the regression that relates $O_2$ concentration to time, and $\phi_d$ is the air-sea oxygen flux as determined by Fick's Law (Leclercq et al., 1999).

Researchers are increasingly assimilating large, high-resolution respirometry data, often capturing multiple response variables such as maximum metabolic rate (MMR, or $MO_{2,max}$), the rate under high activity or exhaustive exercise, or standard (or resting) metabolic rate (SMR, or $MO_{2,min}$), the minimum metabolic cost of maintaining biological functioning (Rogers et al., 2016), or critical oxygen tension, which represents the lowest level of oxygen at which aerobic metabolism is independent of the ambient partial pressure of oxygen ($P_{c}$; Yeager & Ultsch, 1989, Hochachka and Somero, 2002). Experiments may run for long periods (e.g. 20 h, Norin & Malte, 2012), and in most cases, processing the data involves an *ad hoc* selection of data points and them manually performing calculations in a spreadsheet program (e.g. Microsoft Excel) or an integrated development environment (IDE, e.g. R and Matlab). These approaches can be tedious and time consuming especially when spreadsheet programs (e.g. Excel) struggle with the vast datasets that are generated, while IDEs require a degree of expertise and have substantial learning curves. Dedicated software are available to perform such calculations, but most are proprietary and require licensing requirements or dedicated hardware (e.g. AutoResp by Loligo Systems), complicating or preventing their use on multiple machines.

Recently, a number of free R software packages designed for respirometry have become available (e.g. `respirometry`: https://CRAN.R-project.org/package=respirometry, `rMR`: https://CRAN.R-project.org/package=rMR, `LoLinR`: Olito et al., 2017). Both `respirometry` and `rMR` are useful for aquatic respirometry, but are not focused on the analysis of data, although both packages have functions for the analysis of metabolic rate over intervals, and `rMR` has a specialised function to calculate $P_{c}$. For `LoLinR`, the package provides a statistically robust way of automatically detecting a best-fit regression which are applicable for closed and flow-through respirometry. However, `LoLinR`'s processing time increases exponentially with large datasets, with data containing more than 500 observations taking a few minutes to run (Olito et al., 2017), which makes `LoLinR` intractable with large amounts of data.

Here we describe the R package `respR`, a set of functions desgined to provide a structured workflow for the analysis of respirometry-related data (Fig. 1). The package contains utilities to: (1) analyse closed, intermittent, flow-through and open respirometry data, (2) scale $\Delta O_2$ to volume and/or mass, and (3) automatically and rapidly detect MMR, SMR, $P_{c}$ or best-fit results in large datasets with the help of traditional rolling regression and kernel density estimation techniques. Other smaller, but useful, functions are also avaliable, and are described in more detail in our online html vignette (https://januarharianto.github.io/respR/). While the package has a strong focus on marine and freshwater respirometry, the principals also apply to aerial respirometry. Some oxygen concentration conversions require a salinity value, but in freshwater respirometry this should be set to zero. We demonstrate the utility of the package by analysing three datasets as case studies and proof of concept. These data were collected using closed, intermittent and flow-through respirometry.

# Package overview

`respR` can be automatically installed from the GitHub repository using the `devtools` package:

```{r eval=F}
devtools::install_github("januarharianto/respR")
library(respR)
```

To explore `respR` and its main functions we have provided example data that can be called directly after the package is loaded. The first data object, `urchin2013`, contains measurements of oxygen consumption in 16 individual sea urchins (*Heliocidaris erythrogramma*) and 2 "blank" measurements of background respiration (Harianto, *unpublished*). The `intermittent` data object contains three repeated measures of oxygen consumption in *H. erythrogramma*, collected in a single session with intermittent respirometry (Carey et al. 2016, *JEB*). The `flowthrough` data object contains measurements of oxygen consumption, via flow-through respirometry, in a species of chiton, *Mopalia lignosa* (Carey, *unpublished*). Detailed information about all example data, including their source and methods, can be obtained with the `?` command in the R console (e.g. `?urchin2013`).

## Data import and exploration

Data should be formatted correctly before use in `respR`. The function `check.input()` performs error checks on a data frame of any size, and can extract a two-column data frame for data exploration and subsequent analyses. Data must be numeric, because `respR` has limited support for date/time data (e.g. `POSIXct` and `POSIXlt` classes) and performing calculations on different time formats have many caveats that are beyond the scope of the package. Time data should be sequential, without duplicates, as that might signify instrumental drift. Ideally, time data should also be evenly-spaced, that is, the time period between samples are equal. This has important ramifications on data extraction techniques later on as substantial errors may occur in the event that calculations are based on the number of rows instead of time. A plot of the data is also shown for visual inspection (e.g. Fig. 1). 

It should be noted that invoking `check.input` is optional -- the main functions in our package will readily accept any data frame as long as data are numeric. Running `check.input` is an exploratory step that flags potential issues about the data before it is further analysed.  


## Estimating rates of change in $O_2$ concentration ($RO_2$)

The functions `calc.bg.rate()`, `calc.rate()`, `auto.rate()` and `pcrit()` can process raw respirometry data and are called depending on the type of analysis required. 

### Measuring background changes in $RO_2$

Background $RO_2$ is measured to account for the influence of bacterial respiration in the chamber. Since background rates typically account for a small percentage of experimental rates, these often-called “blank” experiments are routinely conducted alongside main experiments, and the rates are averaged across several datasets to obtain a more accurate estimate of the correction. The function `calc.bg.rate()` can simultaneously process multiple background rate measurements, as long as they share the time data, and produces an output object that can be used in later functions that accept background rate arguments.

### Manual and automatic selection of data for calculations

A typical procedure in the analysis respirometry data is to select the most linear section of the data for calculations of $RO_2$ (e.g. citations). The function `calc.rate()` can manually extract one or more segments from a single data frame to process them simultaneously. Data segments can be selected by time period, row numbers, $O_2$ decrease or proportion, which can accomodate most, if not all, data selection requirements and allow for consistent reporting of methods and results (e.g. estimating $RO_2$ over a 10-minute time window across multiple specimens).

Alternatively, we can take advantage of automated methods in `auto.rate()`, which implements novel rolling regression and kernel density estimation algorithms to detect patterns in the data to automatically obtain the maximum, minimum or most linear sections of the data. There are clear advantages in using `auto.rate()` when estimating the prior mentioned metrics. Unlike manual methods where data is most likely arbitrary selected, `auto.rate()` adheres to well-defined rules to obtain the rate of interest, so its methods are results are transparent and fully reproducible. When called, the function takes the data frame of length $m$, and performs a rolling regression of sample size $n$ iteratively across the entire data frame (Fig. 2b). Thus, a total of $(m−n)+1$ number of iterative regressions are fitted, and we obtain a new dataset of regressions as a function of time (Fig. 3), which is then ranked by size to obtain maximum and minimum values. 

To estimate the most linear rate, further computations are performed after rolling regressions. Logically, the most linear section of the data should reflect a consistently stable (i.e. flat) value in the rolling regression data. Thus the value will have a high probability density. The function `auto.rate()` takes advantage of this relationship to identify data that contains the most consistent rate over a rolling window (which equate to peaks in the density plot) and then recalculates the rate across the new data window. This is repeated for all linear sections of the data that are identified by the function, and the results are ranked by size.

### Critical oxygen tension, $P_{c}$

- oxygen tolerance (Hochachka and Somero, 2002)
- broken stick model (Yeager and Ultsch, 1989)
- $RO_2$ vs $P_{O_2}$ data can be generated automatically from raw $O_2$ vs time data. 

## Converting units of $RO_2$ and $MO_2$

- talk about calc.mo2 and conversions to volume and weight specific $MO_2$.


# Reproducibility and data accesibility

We have ensured that any computational analysis performed by `respR` are fully reproducible. All main functions produce an output object of class `list`, which contains all the data and variables needed to re-analyse the results, within R or in other software.

# Tables & Figures

**Table 1.** Main functions available in `respR`.
```{r, echo=F, message=F}
# use this later to show table
library(readr)
listfunctions <- read_csv('tables/list-of-functions.csv')
```

```{r, echo=F, results='asis'}
pander(listfunctions)
```


```{r, echo = F, out.width = "900px"}
knitr::include_graphics("figs/fig1.png")
```

**Fig. 1.** Diagram showing a typical workflow in the analysis of respirometry data using `respR`. Data is first checked for errors before the main functions are used to extract and analyse segments of the data. Summarised results and diagnostic plots provide immediate visual feedback on the outcome of the analyses. Once the rate estimates are obtained, they can be converted into volume and/or mass-specific rates.


```{r, echo = F, out.width = "650px"}
knitr::include_graphics("figs/fig2.png")
```

**Fig. 2** Simplified illustration showing the sampling windows used by `auto.rate()` during **(a)** interval regression analysis, where sample windows do not overlap and **(b)** rolling regression analysis, where sample windows overlap and move forward by one sample unit at a time.


```{r, echo = F, , out.width = "800px"}
knitr::include_graphics("figs/fig3.png")
```

**Fig. 3** Selected output plots from the function `calc.rate()` for the analysis of the data frame `urchin2013`. 
